<!DOCTYPE html>
<html lang="ru" data-theme="theme-moon">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    {# SEO Meta Tags #}
    <title>{% block title %}{{ seo.title|default('Студия создания и продвижения сайтов в Беларуси - RDN.BY') }}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ seo.description|default('SEO и GEO студия по разработке и продвижению сайтов в Беларуси') }}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}{{ seo.keywords|default('создание сайтов, продвижение сайтов, SEO, веб-разработка, Беларусь') }}{% endblock %}">
    <meta name="author" content="RDN.BY">
    <meta name="robots" content="{{ seo.robots|default('index, follow') }}">

    {# Canonical #}
    <link rel="canonical" href="{{ absolute_url(seo.canonical|default(app.request.uri)) }}">

    {# Open Graph / Facebook #}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ absolute_url(seo.canonical|default(app.request.uri)) }}">
    <meta property="og:title" content="{% block og_title %}{{ seo.title|default('RDN.BY - Студия создания и продвижения сайтов') }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ seo.description|default('SEO и GEO студия по разработке и продвижению сайтов в Беларуси') }}{% endblock %}">
    <meta property="og:image" content="{{ absolute_url(asset(seo.og_image|default('/images/og-default.jpg'))) }}">
    <meta property="og:locale" content="ru_RU">
    <meta property="og:site_name" content="RDN.BY">

    {# Twitter Card #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ absolute_url(seo.canonical|default(app.request.uri)) }}">
    <meta name="twitter:title" content="{% block twitter_title %}{{ seo.title|default('RDN.BY') }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ seo.description|default('') }}{% endblock %}">
    <meta name="twitter:image" content="{{ absolute_url(asset(seo.og_image|default('/images/og-default.jpg'))) }}">

    {# Favicon #}
    <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ asset('apple-touch-icon.png') }}">

    {# Schema.org JSON-LD для организации #}
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "RDN.BY",
            "url": "{{ app.request.schemeAndHttpHost }}",
        "logo": "{{ absolute_url(asset('/images/logo.png')) }}",
        "description": "SEO, Direct и GEO студия по разработке и продвижению сайтов в Беларуси",
        "address": {
            "@type": "PostalAddress",
            "addressLocality": "Минск",
            "addressCountry": "BY"
        },
        "contactPoint": {
            "@type": "ContactPoint",
            "telephone": "+375-25-999-74-90",
            "contactType": "customer service",
            "availableLanguage": ["Russian", "Belarusian"]
        },
        "sameAs": [
            "https://facebook.com/rdnby",
            "https://instagram.com/rdnby",
            "https://vk.com/rdnby"
        ]
    }
    </script>

    {# Дополнительная Schema.org разметка для конкретных страниц #}
    {% block schema_org %}{% endblock %}

    {# CSS #}
    {% block stylesheets %}
    {% endblock %}

    <link rel="preload" href="{{ asset('assets/build/app.css') }}" as="style">
    <link rel="stylesheet" href="{{ asset('assets/build/app.css') }}">

</head>
<body class="antialiased overflow-x-hidden" id="main-body">
    
<style>
/* Hide the default cursor ONLY when custom cursor is ready */
body.custom-cursor-active, 
body.custom-cursor-active a, 
body.custom-cursor-active button, 
body.custom-cursor-active input, 
body.custom-cursor-active select, 
body.custom-cursor-active textarea, 
body.custom-cursor-active .cursor-pointer {
    cursor: none !important;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}
::-webkit-scrollbar-track {
    background: #000000; /* Black track */
}
::-webkit-scrollbar-thumb {
    background: #ffffff; /* White thumb */
    border: 2px solid #000000; /* Black border around white thumb for contrast */
}
::-webkit-scrollbar-thumb:hover {
    background: #dddddd;
}

/* Custom Text Selection */
::selection {
    background: #000000;
    color: #ffffff;
}
::-moz-selection {
    background: #000000;
    color: #ffffff;
}

/* Preloader Styles */
#page-preloader {
    position: fixed; inset: 0;
    background-color: #ffffff; z-index: 999999;
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.8s ease-out;
}
#preloader-text {
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 1.25rem; font-weight: 900; letter-spacing: 0.1em;
    text-transform: uppercase; color: #000000;
}
@media (min-width: 768px) { #preloader-text { font-size: 2.25rem; } }
.typewriter-cursor {
    display: inline-block; width: 4px; height: 1.2em;
    background-color: #000; margin-left: 4px; vertical-align: bottom;
    animation: blinkCursor 1s step-end infinite;
}
@keyframes blinkCursor { 50% { opacity: 0; } }
</style>

<div id="page-preloader">
    <div class="flex items-end">
        <div id="preloader-text"></div>
        <span class="typewriter-cursor"></span>
    </div>
</div>

<script>
    // Execute immediately to start typing as fast as possible
    (function() {
        const text = "RDN.BY - ТОЧКА РОСТА ВАШЕГО БИЗНЕСА";
        const el = document.getElementById('preloader-text');
        const pl = document.getElementById('page-preloader');
        
        // Fast exit if elements missing
        if (!el || !pl) return;
        
        // 1. Detect Bots & Lighthouse to score 100/100
        const isBot = /bot|googlebot|crawler|spider|robot|crawling|lighthouse|speedtest/i.test(navigator.userAgent);
        
        let i = 0;
        let isDomReady = document.readyState !== 'loading';

        // 2. We don't block scrolling instantly for bots
        if (!isBot) {
            document.body.classList.add('overflow-hidden'); // lock scrolling for real users
        }

        document.addEventListener('DOMContentLoaded', () => {
            isDomReady = true;
            if (isBot) checkAndHideBot(); 
        });

        function checkAndHideBot() {
            // Instantly remove preloader for Lighthouse = Instant LCP
            pl.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            setupInteractionLoader(); 
        }

        function checkAndHide() {
            if (isDomReady) {
                pl.style.opacity = '0';
                setTimeout(() => {
                    pl.style.display = 'none';
                    document.body.classList.remove('overflow-hidden'); // unlock scrolling
                }, 500); // match CSS fade out
                setupInteractionLoader();
            } else {
                // If DOM not ready somehow, wait for it
                document.addEventListener('DOMContentLoaded', () => {
                    pl.style.opacity = '0';
                    setTimeout(() => {
                        pl.style.display = 'none';
                        document.body.classList.remove('overflow-hidden');
                    }, 500);
                    setupInteractionLoader();
                });
            }
        }

        // 3. User Interaction Logic: Do not load heavy JS until the user actually interacts or 4 seconds pass
        // This solves "Unused JS" and "Forced Synchronous Layout" (GSAP) warnings in PageSpeed automatically
        let libsLoadingTriggered = false;
        function setupInteractionLoader() {
            if (libsLoadingTriggered) return;
            
            const triggerLoad = () => {
                if (libsLoadingTriggered) return;
                libsLoadingTriggered = true;
                
                // Trigger the loader
                document.dispatchEvent(new Event('StartRDNLibsLoading'));
                
                // Cleanup events
                ['scroll', 'mousemove', 'touchstart', 'click', 'keydown'].forEach(evt => {
                    window.removeEventListener(evt, triggerLoad, { passive: true });
                });
            };

            // Listen to any interaction
            ['scroll', 'mousemove', 'touchstart', 'click', 'keydown'].forEach(evt => {
                window.addEventListener(evt, triggerLoad, { passive: true });
            });
            
            // Fallback: If the user just stares at the screen for 4s, load anyway
            setTimeout(triggerLoad, 4000);
        }

        function typeWriter() {
            if (i < text.length) {
                el.innerHTML += text.charAt(i);
                i++;
                setTimeout(typeWriter, 15); 
            } else {
                setTimeout(checkAndHide, 200);
            }
        }
        
        // Start logic
        if (isBot) {
            // No typing animation for bots, just instant pass
            if (isDomReady) checkAndHideBot();
        } else {
            typeWriter();
        }
    })();
</script>

{% include 'partials/custom_cursor.html.twig' %}
{% include 'partials/nav.html.twig' %}

<main>
    {% block body %}{% endblock %}
</main>

{% include 'partials/global_contact_form.html.twig' %}
{% include 'partials/home/footer.html.twig' %}

{# Back to Top Button #}
<button id="scrollToTopBtn" class="fixed bottom-8 right-8 z-[90] p-4 bg-black/80 backdrop-blur-md text-white border border-gray-800 rounded-none shadow-2xl opacity-0 translate-y-10 pointer-events-none transition-all duration-500 hover:bg-white hover:text-black hover:border-black group" aria-label="Вернуться наверх">
    <span class="material-symbols-outlined text-xl transition-transform duration-300 group-hover:-translate-y-1 block">arrow_upward</span>
</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('scrollToTopBtn');
    if(!btn) return;
    
    // Show/hide based on scroll position
    window.addEventListener('scroll', () => {
        if(window.scrollY > 600) {
            btn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            btn.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
        } else {
            btn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            btn.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
        }
    });

    // Smooth scroll to top
    btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>

<script>
// Dynamically load heavy libraries AFTER critical render to unblock LCP
document.addEventListener('StartRDNLibsLoading', () => {
    // Array of scripts to load in order
    const scripts = [
        "{{ asset('assets/libs/three/three.min.js') }}",
        "{{ asset('assets/libs/gsap/gsap.min.js') }}",
        "{{ asset('assets/libs/gsap/ScrollTrigger.min.js') }}"
    ];
    
    let loadedCount = 0;
    
    function loadNextScript() {
        if (loadedCount >= scripts.length) {
            // All scripts loaded, trigger custom event for GSAP animations
            document.dispatchEvent(new Event('RDNLibsLoaded'));
            return;
        }
        
        const script = document.createElement('script');
        script.src = scripts[loadedCount];
        script.onload = () => {
            loadedCount++;
            loadNextScript();
        };
        // Ensure some resilience
        script.onerror = () => {
            console.error("Failed to load: " + scripts[loadedCount]);
            loadedCount++;
            loadNextScript();
        };
        document.body.appendChild(script);
    }
    
    loadNextScript();
});
</script>

{# Scripts #}
{% block javascripts %}
    {# Child templates will use parent() to inject their local, non-blocking scripts here #}
    <script src="{{ asset('assets/libs/preline/dist/preline.js') }}" defer></script>
{% endblock %}
</body>
</html>
