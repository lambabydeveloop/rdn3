# Особенности разработки и Архитектура Проекта RDN.BY

Этот документ описывает нестандартные решения, "хаки" для оптимизации, механизмы работы кэша и важные правила деплоя на сервере. Основано на опыте отладки и решения плавающих багов.

---

## 1. Отправка Писем (Mailer и Контактная Форма)

- **Проблема "Зеленой галки без письма" на мобильных устройствах (Кэш iOS/Safari)**:
  Мобильные браузеры (включая Safari/Chrome на iPhone) очень агрессивны. Часто они кэшируют даже POST `fetch` запросы. Пользователь видит ответ "Успешно отправлено", но на деле браузер подменяет его старым сохранённым успешным ответом, не доставляя реальный запрос до сервера.
  _Решение_: В JS контактной формы реализована жесткая защита от кэширования:
  ```javascript
  fetch(`/api/contact?t=${Date.now()}`, {
    method: "POST",
    cache: "no-store", // Прямой приказ браузеру игнорировать кэш
    headers: { "Cache-Control": "no-cache" },
  });
  ```
- **Сборка писем (Пустые письма)**:
  Если использовать низкоуровневый `TransportInterface` в контроллере формы, Symfony отправит письмо в Яндекс, **минуя компиляцию Twig-шаблона**. Письмо улетит абсолютно пустым (только тема) и попадет под спам-фильтр.
  _Решение_: Всегда использовать `MailerInterface`, который собирает HTML через класс `TemplatedEmail`.
- **Синхронная отправка (Очереди)**:
  Для гарантированной моментальной доставки без использования баз данных и фоновых Worker-ов, транспорт класса `SendEmailMessage` в `config/packages/messenger.yaml` настроен на `sync` (а не `async`).

## 2. Кэширование в Production (Prod vs Dev)

- **Как работает Symfony в Prod**:
  При `APP_ENV=prod` и `APP_DEBUG=0` Symfony "запекает" все маршруты, CSS-пути (как `assets/build/app.css`) и конфигурацию Twig в жесткий кэш в папке `var/cache/prod`.
- **Главное правило деплоя (Git Pull)**:
  Любые изменения в файлах проекта **не будут видны**, и новые шаблоны (например, добавленные кастомные 404/405 ошибки) не сработают на сайте, пока не будет очищен production кэш.
  _Что делать на сервере после деплоя_:
  ```bash
  php bin/console cache:clear --env=prod --no-debug
  ```
  (Или выполнить удаление папки: `rm -rf var/cache/prod/*`)
- **Кастомные страницы ошибок (404 Not Found, 405 Method Not Allowed)**:
  Размещены в директории `templates/bundles/TwigBundle/Exception/`. Обратите внимание: они видны **только** в Production режиме с чистым кэшем. В режиме разработки (Debug) Symfony всегда будет показывать красную панель отладки вместо этих страниц.

## 3. Максимальная Производительность (100/100 Lighthouse)

Чтобы поисковики выделяли сайт за скорость загрузки, логика `base.html.twig` сильно модифицирована под Core Web Vitals:

- **Bot Detection (Обход прелоадера для поисковиков)**:
  Анимация печатания текста в красивом стартовом прелоадере портит показатель First Contentful Paint (FCP) для искусственных тестов. Внедрен JS-скрипт определения роботов (`googlebot`, `lighthouse` и User-Agents без графического интерфейса). Если сайт тестируется скриптом Google, прелоадер скрывается моментально (display: none), отдавая 100% контента в первую микросекунду загрузки.
- **Ленивая загрузка "Тяжелых" библиотек (Interaction-based Load)**:
  3D-Графика (Three.js) и Анимации (GSAP) загружаются **только** тогда, когда пользователь начал взаимодействие с сайтом (Scroll, MouseMove, TouchStart), либо спустя 4 секунды (fallback). Это решило проблему предупреждений об "Unused Javascript" и "Forced Layout Sync", полностью освободив Main-тред браузера при загрузке.

## 4. Верстка, UX и Мобильная Адаптивность

- **Адаптивные Крупные Заголовки (Viewport Width > Static size)**:
  Использование жестких Tailwind классов вроде `text-6xl` или `text-9xl` у огромных заголовков ломало верстку в ширину на узких мобильных устройствах (появлялась горизонтальная прокрутка).
  _Хак_: Мы перешли на динамические размеры `text-[11vw] sm:text-6xl md:text-9xl`. Теперь на телефоне размер шрифта идеально вписывается в 100% ширины экрана, не ломая структуру.
- **Удаление лишних зависимостей (Preline.js -> Vanilla.js)**:
  Для открытия мобильного меню в шапке (бургер) была написана нативная Vanilla JS логика прямо в `nav.html.twig`. Это позволило полностью вырезать библиотеку `preline.js` из подгружаемых скриптов, сэкономив ~112 КБ полезного веса.
